Bootstrap: docker
From: docker.io/rootproject/root:6.36.00-ubuntu25.04

%labels
    Author Matthew McNeaney
    Version 1.0

%environment
    export DEBIAN_FRONTEND=noninteractive
    export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
    export PATH=${JAVA_HOME}/bin:${PATH}
    export GROOVY_VERSION=5.0.0
    export GROOVY_HOME=/opt/groovy-${GROOVY_VERSION}
    export PATH=${GROOVY_HOME}/bin:${PATH}
    export C12ANALYSIS=/usr/src/clas12-analysis
    cd $C12ANALYSIS && source $C12ANALYSIS/bin/env.sh
    export C12ANALYSIS_INSTALL_DIR=/opt/clas12-analysis/

%post
    export DEBIAN_FRONTEND=noninteractive
    export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
    export PATH=${JAVA_HOME}/bin:${PATH}
    export GROOVY_VERSION=5.0.0
    export GROOVY_HOME=/opt/groovy-${GROOVY_VERSION}
    export PATH=${GROOVY_HOME}/bin:${PATH}
    export C12ANALYSIS=/usr/src/clas12-analysis
    export C12ANALYSIS_INSTALL_DIR=/opt/clas12-analysis/

    set -e
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        wget \
        curl \
        unzip \
        zip \
        gnupg \
        software-properties-common \
        openjdk-21-jdk \
        maven \
        python3 \
        python3-pip \
        scons \
        ca-certificates \
        locales \
        && rm -rf /var/lib/apt/lists/*

    # Download and install Groovy binary distribution
    wget -q https://groovy.jfrog.io/artifactory/dist-release-local/groovy-zips/apache-groovy-binary-${GROOVY_VERSION}.zip -O /tmp/groovy.zip
    unzip -q /tmp/groovy.zip -d /opt
    rm -f /tmp/groovy.zip

    # Create application directory (will be populated by %files)
    mkdir -p /usr/src/clas12-analysis

%files
    ./ /usr/src/clas12-analysis

%post
    set -e
    cd /usr/src/clas12-analysis

    # Run build scripts to reproduce Dockerfile behavior
    # Build j2root project
    if [ -x ./bin/build_j2root.sh ]; then
        bash -c "./bin/build_j2root.sh"
    fi

    # Build clasqaDB project
    if [ -x ./bin/build_clasqaDB.sh ]; then
        bash -c "./bin/build_clasqaDB.sh"
    fi

    # Build gradle project
    if [ -x ./bin/build_gradle.sh ]; then
        bash -c "./bin/build_gradle.sh"
    fi

    # Create install directory and move jars if present
    mkdir -p /opt/clas12-analysis
    mv app/build/libs/*.jar /opt/clas12-analysis/ 2>/dev/null || true

    # Ensure run.sh is executable
    chmod +x /usr/src/clas12-analysis/bin/run.sh || true

%runscript
    /bin/bash -lc "cd /usr/src/clas12-analysis && source /usr/src/clas12-analysis/bin/env.sh"

%startscript
    # Non-interactive start script for instances: source environment and run default application
    /bin/bash -lc "cd /usr/src/clas12-analysis && source /usr/src/clas12-analysis/bin/env.sh && exec /usr/src/clas12-analysis/bin/run.sh $@"
